document.addEventListener("DOMContentLoaded", function() {
fetch('http://localhost:5000/SelectTable')
    .then(response => response.json())
    .then(data => {
        const timetable = data.timetable;
        const tbody = document.querySelector("#timetable tbody");
        timetable.forEach(entry => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${entry.day}</td>
                <td>${entry.from}</td>
                <td>${entry.to}</td>
            `;
            tbody.appendChild(row);
        });
    })
    .catch(error => console.error('Error fetching timetable:', error));
});



//////////////////////////////////////////////////////////////////////////////////////////

from flask import Flask, request, jsonify, Blueprint
from flask_sqlalchemy import SQLAlchemy

app = Flask(__name__)

app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql+pymysql://uuamb2qozqulxtk5:zdaQnAxlHkA4S0PNqOqv@bcqkw1nmvy6embwex6i5-mysql.services.clever-cloud.com:3306/bcqkw1nmvy6embwex6i5'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)
db.init_app(app)

class TableTimeEmp(db.Model):
    __tablename__ = 'TableTimeEmp'
    id = db.Column(db.Integer, primary_key=True)
    day = db.Column(db.String(50), nullable=False)
    from_h = db.Column(db.String(50), nullable=False)
    to_h = db.Column(db.String(50), nullable=False)

BpAdd = Blueprint('add', __name__)

@BpAdd.route('/addTime', methods=['POST'])
def add_time_work():
    data = request.form
    day = data.get('day')
    from_time = data.get('from')
    to_time = data.get('to')

    new_time = TableTimeEmp(day=day, from_h=from_time, to_h=to_time)

    try:
        db.session.add(new_time)
        db.session.commit()
        return jsonify({"message": "Time added successfully"}), 200
    except Exception as e:
        db.session.rollback()
        return jsonify({"error": str(e)}), 500

BpSelect = Blueprint('selectTable', __name__)

@BpSelect.route('/SelectTable', methods=['GET'])
def selectTable():
    try:
        results = TableTimeEmp.query.all()
        timetable = [
            {"day": result.day, "from": result.from_h, "to": result.to_h}
            for result in results
        ]
        return jsonify({"timetable": timetable}), 200
    except Exception as e:
        return jsonify({"error": str(e)}), 500


    



//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////








function changeBodyContent_add() {
    var bodyDiv = document.querySelector('.body');
    if (!window.originalBodyContent) {
        window.originalBodyContent = bodyDiv.innerHTML;
    }

    if (!document.getElementById('add')) {
        var template = document.getElementById('card-template_add');
        var card = template.content.cloneNode(true);

        bodyDiv.appendChild(card);

        var opF = document.getElementById('from');
        var opT = document.getElementById('to');
        for (let i = 0; i < 24; i++) {
            var optionT = document.createElement('option');
            let hour = i < 10 ? '0' + i : i;
            let nextH = parseInt(hour) + 1;
            if(hour < 9) {
                nextH = '0' + nextH;
            }
            optionT.value = optionT.text = `${hour}:${nextH}`;
            opF.appendChild(optionT);
            opT.appendChild(optionT.cloneNode(true));
        }

        card.querySelector('.back').addEventListener('click', function (e) {
            e.preventDefault();
            restoreOriginalContent();
        });

    } else {
        document.getElementById('add').style.display = "block";
    }
    
};

function restoreOriginalContent() {
    var overlay = document.querySelector('.card');
    if (overlay) {
        overlay.remove();
    }
};

document.addEventListener("DOMContentLoaded", function() {
    fetch('http://localhost:5000/SelectTable')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            console.log('Data fetched successfully:', data);
            const timetable = data.timetable;
            timetable.forEach(entry => {
                const day = entry.day;
                const from = entry.from;
                const to = entry.to;

                let [fromH1, fromH2] = from.split(':').map(Number);
                let [toH1, toH2] = to.split(':').map(Number);

                let currentHour = fromH1;
                let currentHour2 = fromH2;

               
                const time = `${currentHour < 10 ? '0' : ''}${currentHour}:${currentHour2 < 10 ? '0' : ''}${currentHour2}`;
                const cellId = `${day}-${time}`;
                const cell = document.getElementById(cellId);

                console.log(`Looking for cell with ID: ${cellId}`);

                if (cell) {                        
                    cell.style.backgroundColor = 'black';
                    const btn = document.createElement('button');
                    btn.classList.add('deletebtn');
                    btn.addEventListener('click', () => HandleEvent(day, time));
                    cell.appendChild(btn);
                    console.log('Updated cell:', cell);
                } else {
                    console.error(`No cell found for ID: ${cellId}`);
                }

                    
            });
        })
        .catch(error => console.error('Error fetching timetable:', error));

});

function HandleEvent(day, from) {
    fetch('http://localhost:5000/DeleteWork', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `day=${encodeURIComponent(day)}&from=${encodeURIComponent(from)}`
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
        }
        return response.json();
    })
    .then(data => {
        console.log('Delete successful:', data);
    })
    .catch(error => console.error('Error deleting entry:', error));
}




